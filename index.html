<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro Álbum Digital Pedagógico</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- VARIABLES & RESET (CÓDIGO ORIGINAL) --- */
        :root {
            --book-width: 460px;
            --book-height: 600px;
            
            /* vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv */
            /* --- AQUÍ PUEDES EDITAR EL COLOR DE FONDO (Color detrás del libro) --- */
            --bg-color: #BDBDBD; 
            /* ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ */

            --paper-texture: #fdfbf7;
            --text-color: #2c3e50;
            --accent-color: #5d4037;
            --gold-color: #d4af37;
            --endpaper-bg: #a5d6a7; 
            --endpaper-dot: #ffffff; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }

        /* --- UI EXTERNA --- */
        .sidebar {
            position: fixed; left: 0; top: 0; bottom: 0; width: 50px;
            background: #fff; border-right: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        .project-title {
            writing-mode: vertical-rl; transform: rotate(180deg);
            font-family: 'Cinzel', serif; font-weight: 700; color: #888;
            letter-spacing: 3px; font-size: 12px;
        }

        .top-controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px;
        }
        .btn-icon {
            background: white; border: none; width: 35px; height: 35px;
            border-radius: 50%; cursor: pointer; color: #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .btn-icon:hover { color: var(--accent-color); transform: scale(1.1); }

        /* --- ESCENARIO 3D --- */
        #stage {
            perspective: 2500px;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.5s ease;
        }

        .book {
            position: relative;
            width: var(--book-width);
            height: var(--book-height);
            transform-style: preserve-3d;
            transition: transform 0.6s ease-in-out;
            /* La clase .opened aplicará el translateX(50%) para centrar las páginas dobles */
        }

        /* ------------------------------------------------------------------------- */
        /* --- AJUSTE DE SOMBRA REALISTA (NUEVO) --- */
        /* ------------------------------------------------------------------------- */
        /* Creamos una sombra "falsa" detrás del libro que se anima según el estado */
        .book::before {
            content: '';
            position: absolute;
            z-index: -1; /* Para que quede detrás de las hojas */
            
            /* Posición inicial (Libro cerrado - Portada) */
            width: 96%; 
            height: 96%; 
            left: 5%; 
            top: 5%;
            
            /* Estilo visual de la sombra sutil - AJUSTADO SEGÚN IMAGEN DE REFERENCIA */
            background: rgba(0,0,0,0.4); 
            filter: blur(25px); /* Difuminado para que no parezca un cuadro sólido */
            border-radius: 20px;
            
            /* Animación suave para acompañar el movimiento del libro */
            transition: all 0.6s ease-in-out;
            opacity: 0.7;
        }

        /* 1. Cuando el libro está ABIERTO: La sombra se duplica y se centra */
        .book.opened::before {
            width: 196%; /* Casi el doble de ancho */
            left: -95%; /* Se mueve a la izquierda para cubrir la página abierta */
            opacity: 0.5; /* Un poco más suave al estar extendida */
            background: rgba(0,0,0,0.3);
        }

        /* 2. Cuando el libro está CERRADO AL FINAL (Contraportada): La sombra va a la izquierda */
        .book.closed-back::before {
            width: 96%;
            left: -99%; /* La sombra se mueve a donde están las hojas apiladas */
        }
        /* ------------------------------------------------------------------------- */


        .book.opened { 
            transform: translateX(50%); 
        }
        
        /* --- AJUSTE AGREGADO: CENTRADO DE CONTRAPORTADA --- */
        .book.closed-back {
            transform: translateX(100%);
        }
        /* -------------------------------------------------- */

        /* --- HOJAS (PAPERS) --- */
        .paper {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            transform-origin: left center;
            transition: transform 1s cubic-bezier(0.645, 0.045, 0.355, 1);
            transform-style: preserve-3d;
        }
        .paper.flipped { transform: rotateY(-180deg); z-index: 0; }

        /* --- CARAS DE LA HOJA --- */
        .front, .back {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            background-color: var(--paper-texture);
            backface-visibility: hidden;
            overflow: hidden;
            border-radius: 2px 5px 5px 2px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); }
        .back { 
            z-index: 1; transform: rotateY(180deg); 
            border-left: 1px solid rgba(0,0,0,0.1);
            border-radius: 5px 2px 2px 5px; 
        }

        /* Sombras del lomo */
        .front::after {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 25px;
            background: linear-gradient(to right, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 100%);
            pointer-events: none;
        }
        .back::after {
            content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 25px;
            background: linear-gradient(to left, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 100%);
            pointer-events: none;
        }

        /* --- ESTILOS DE PÁGINA --- */
        .image-page {
            background-size: cover;
            background-position: center;
            background-color: #fff;
        }
        .image-page .content-wrapper { display: none; }

        .text-page {
            background-color: #fffefae6;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 60px; text-align: center;
        }
        
        .text-page h2 {
            font-family: 'Cinzel', serif; color: var(--accent-color);
            font-size: 1.4rem; margin-bottom: 25px;
            position: relative; padding-bottom: 15px;
        }
        .text-page h2::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 40px; height: 1px; background: var(--gold-color);
        }
        .text-page p {
            font-family: 'Merriweather', serif; font-size: 0.95rem;
            line-height: 2; color: #555; font-style: italic;
        }
        .legal-text { font-size: 0.75rem !important; color: #888 !important; font-style: normal !important; }

        .endpaper {
            background-color: var(--endpaper-bg);
            background-image: radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px), radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* --- ESTILO PARA NUMERACIÓN DE PÁGINAS --- */
        .page-number {
            position: absolute;
            bottom: 20px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            color: var(--text-color);
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            z-index: 10;
        }
        .front .page-number { right: 20px; }
        .back .page-number { left: 20px; }


        /* --- BOTONES NAVEGACIÓN --- */
        .nav-btn {
            position: fixed; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.8); border: none;
            width: 50px; height: 50px; border-radius: 50%;
            cursor: pointer; z-index: 90; transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .nav-btn:hover:not(:disabled) { background: white; transform: translateY(-50%) scale(1.1); color: var(--accent-color); }
        .nav-btn:disabled { opacity: 0.3; cursor: default; }
        .prev-btn { left: 70px; }
        .next-btn { right: 70px; }

        @media (max-width: 1100px) {
            :root { --book-width: 350px; --book-height: 500px; }
            .prev-btn { left: 20px; } .next-btn { right: 20px; }
            .sidebar { display: none; }
        }

        /* ========================================================================= */
        /* --- AJUSTE MÓVIL ESPECÍFICO (CORRECCIÓN DE DEFORMACIÓN Y BURBUJAS) --- */
        /* ========================================================================= */
        @media (max-width: 768px) {
            :root { 
                /* CORRECCIÓN DE DEFORMACIÓN: */
                /* Usamos el ancho máximo posible seguro (44vw por página = 88vw total) */
                --book-width: 44vw; 
                /* La altura NO es fija, se calcula proporcionalmente al ancho (ratio 1.35 aprox) */
                --book-height: calc(44vw * 1.35); 
            }

            /* Perspectiva más suave */
            #stage { perspective: 1200px; }

            /* Ajuste de textos internos */
            .text-page { padding: 15px; }
            .text-page h2 { font-size: 0.8rem; margin-bottom: 8px; }
            .text-page p { font-size: 0.55rem; line-height: 1.4; }
            .legal-text { font-size: 0.45rem !important; }
            .page-number { font-size: 8px; bottom: 8px; }

            /* Controles abajo */
            .nav-btn {
                top: auto; bottom: 30px; transform: none;
                width: 40px; height: 40px;
                background: rgba(255,255,255,0.9);
                border: 1px solid #ddd;
            }
            .prev-btn { left: 20px; }
            .next-btn { right: 20px; }
        }

        /* ========================================================================= */
        /* --- ESTILO: SISTEMA DE ETIQUETAS PEDAGÓGICAS Y PERSONAJE --- */
        /* ========================================================================= */
        .pedagogical-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: stretch; 
            padding: 0 5px; 
        }

        .ped-label-container {
            width: 250px;
            display: flex;
            flex-direction: column;
            transition: padding 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .align-bottom { justify-content: flex-end; padding-top: 0; }
        .align-top { justify-content: flex-start; padding-bottom: 0; }

        .ped-label-left { margin-left: 5px; text-align: right; align-items: flex-end; }
        .ped-label-right { margin-right: 5px; text-align: left; align-items: flex-start; }

        .ped-cloud, .ped-character {
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .ped-cloud {
            background-color: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border: 1px solid #eee;
            position: relative;
            max-width: 100%;
            margin-bottom: 10px;
        }

        .ped-character {
            width: 120px; height: auto; transition-delay: 0.1s; 
        }

        /* ANIMACIONES */
        .ped-label-left .ped-cloud, .ped-label-left .ped-character { transform: translateX(-150px); }
        .ped-label-left .ped-cloud.active, .ped-label-left .ped-character.active { opacity: 1; transform: translateX(0); }

        .ped-label-right .ped-cloud { transform: translateX(150px); }
        .ped-label-right .ped-cloud.active { opacity: 1; transform: translateX(0); }

        .ped-label-right .ped-character { transform: translateX(150px) scaleX(-1); }
        .ped-label-right .ped-character.active { opacity: 1; transform: translateX(0) scaleX(-1); }

        /* Triangulitos nube */
        .ped-label-left .ped-cloud::after {
            content: ''; position: absolute; top: 100%; right: 40px; 
            border-width: 10px 10px 0 10px; border-style: solid; border-color: #fff transparent transparent transparent;
        }
        .ped-label-right .ped-cloud::after {
            content: ''; position: absolute; top: 100%; left: 40px; 
            border-width: 10px 10px 0 10px; border-style: solid; border-color: #fff transparent transparent transparent;
        }

        .ped-cloud h3 {
            font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 1rem;
            margin-bottom: 8px; border-bottom: 2px solid var(--gold-color); display: inline-block; padding-bottom: 3px;
        }
        .ped-cloud p { font-family: 'Lato', sans-serif; font-size: 0.85rem; color: #666; line-height: 1.5; }

        @media (max-width: 1300px) {
            .ped-label-container { width: 200px; }
        }

        /* --- CORRECCIÓN FINAL: VISIBILIDAD DE PERSONAJES EN MÓVIL --- */
        /* Eliminamos el display:none que los ocultaba y los adaptamos */
        @media (max-width: 900px) {
            /* Permitimos que se vean, pero ajustamos tamaño */
            .pedagogical-layer { display: flex; } 
            
            .ped-label-container { width: 140px; } /* Más angostos */
            
            .ped-character { width: 80px; } /* Personajes más pequeños */
            
            .ped-cloud { 
                padding: 10px; 
                margin-bottom: 5px;
            }
            .ped-cloud h3 { font-size: 0.8rem; margin-bottom: 4px; }
            .ped-cloud p { font-size: 0.65rem; line-height: 1.2; display: none; } /* Solo mostramos título en móvil para no saturar */
            .ped-cloud p:first-of-type { display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        }

        /* ------------------------------------------------------------------------- */
        /* --- ESTILOS DE LA VENTANA DE BIENVENIDA (POPUP) (NUEVO) --- */
        /* ------------------------------------------------------------------------- */
        .intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000; /* Encima de todo */
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
            transition: opacity 0.5s ease;
        }
        .intro-modal {
            background: #fff;
            width: 90%; max-width: 500px;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid var(--gold-color);
        }
        .intro-character-circle {
            width: 150px; height: 150px;
            background: var(--endpaper-bg);
            border-radius: 50%;
            margin: -80px auto 20px auto; /* Para que sobresalga arriba */
            border: 5px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .intro-character-img {
            width: 80%; height: auto;
        }
        .intro-title {
            font-family: 'Cinzel', serif; color: var(--accent-color);
            font-size: 1.5rem; margin-bottom: 15px;
        }
        .intro-text {
            font-family: 'Lato', sans-serif; color: #555;
            font-size: 1rem; line-height: 1.6; margin-bottom: 25px;
        }
        .close-intro-btn {
            position: absolute; top: 15px; right: 15px;
            background: transparent; border: none;
            font-size: 1.5rem; color: #999; cursor: pointer;
            transition: 0.3s;
        }
        .close-intro-btn:hover { color: var(--accent-color); transform: rotate(90deg); }
        .action-btn {
            background: var(--accent-color); color: #fff;
            border: none; padding: 12px 30px;
            font-family: 'Cinzel', serif; font-size: 1rem;
            border-radius: 30px; cursor: pointer;
            transition: 0.3s; box-shadow: 0 5px 15px rgba(93, 64, 55, 0.3);
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(93, 64, 55, 0.4); background: var(--gold-color); }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="project-title">Libro Álbum Digital</div>
    </div>

    <div class="top-controls">
        <button class="btn-icon" onclick="toggleZoom()" title="Zoom"><i class="fas fa-search-plus"></i></button>
        <button class="btn-icon" onclick="toggleFullScreen()" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
    </div>

    <button class="nav-btn prev-btn" id="prevBtn" onclick="goPrev()"><i class="fas fa-chevron-left"></i></button>

    <div id="stage">
        <div class="book" id="book">
            </div>
    </div>

    <button class="nav-btn next-btn" id="nextBtn" onclick="goNext()"><i class="fas fa-chevron-right"></i></button>

    <audio id="pageFlipSound" src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/sonido%20deslizar.mp3" preload="auto"></audio>

    <div class="pedagogical-layer">
        <div id="container-left" class="ped-label-container ped-label-left">
            <div id="cloud-left" class="ped-cloud">
                <h3 id="title-left">Título</h3>
                <p id="desc-left">Descripción...</p>
            </div>
            <img id="char-left" class="ped-character" 
                 src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20izquierda.png?raw=true" 
                 alt="Personaje Guía">
        </div>

        <div id="container-right" class="ped-label-container ped-label-right">
            <div id="cloud-right" class="ped-cloud">
                <h3 id="title-right">Título</h3>
                <p id="desc-right">Descripción...</p>
            </div>
            <img id="char-right" class="ped-character" 
                 src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20derecha.png?raw=true" 
                 alt="Personaje Guía">
        </div>
    </div>

    <!-- AQUÍ ESTÁ LA NUEVA VENTANA DE BIENVENIDA -->
    <div class="intro-overlay" id="introOverlay">
        <div class="intro-modal">
            <button class="close-intro-btn" onclick="closeIntro()"><i class="fas fa-times"></i></button>
            <div class="intro-character-circle">
                <img src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20derecha.png?raw=true" class="intro-character-img" alt="Guía">
            </div>
            <h2 class="intro-title">¡Hola, Aventurero!</h2>
            <p class="intro-text">
                Aquí vas a ver un ejemplo de la estructura de un <strong>Libro Álbum Ilustrado</strong> y cuáles son las características de cada una de sus partes.
                <br><br>
                ¡Prepárate para explorar!
            </p>
            <button class="action-btn" onclick="closeIntro()">Comenzar Lectura</button>
        </div>
    </div>

    <script>
        // Función para cerrar la ventana de bienvenida
        function closeIntro() {
            const overlay = document.getElementById('introOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        }

        const bookData = [
            // HOJA 1: Portada (Imagen) + Guarda Delantera
            {
                front: {
                    type: "image-page",
                    bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/portada%20forntal.PNG?raw=true",
                    // TEXTO ACTUALIZADO: PORTADA
                    tooltip: { title: "La Portada", text: "Es la cara del libro. Debe llevar el título, nombre del autor/ilustrador y el sello editorial para atrapar al lector." }
                },
                back: {
                    type: "endpaper",
                    // TEXTO ACTUALIZADO: GUARDAS
                    tooltip: { title: "Guardas Delanteras", text: "Son las hojas que unen las tapas con el cuerpo del libro. Su diseño anticipa la atmósfera de la obra." }
                }
            },
            // HOJA 2: Guarda + Hoja de Respeto
            {
                front: {
                    type: "endpaper",
                    // TEXTO ACTUALIZADO: GUARDAS
                    tooltip: { title: "Concepto de Guardas", text: "Funcionan como una transición visual. El color o patrón usado aquí prepara emocionalmente al lector." }
                },
                back: {
                    type: "text-page",
                    title: "El Susurro de las Cumbres",
                    text: "(Hoja de Respeto)",
                    // TEXTO ACTUALIZADO: HOJA DE RESPETO
                    tooltip: { title: "Hoja de Respeto", text: "Página de cortesía que solo lleva el título de la obra en menor tamaño. Da un respiro antes de iniciar." }
                }
            },
            // HOJA 3: Créditos + Dedicatoria
            {
                front: {
                    type: "text-page",
                    title: "Créditos",
                    text: "<span class='legal-text'>Primera Edición Digital, 2024<br>Ilustraciones: Nature Collection<br>Diseño: Front-End Expert<br>ISBN: 978-0-123-45678-9<br>Todos los derechos reservados.</span>",
                    // TEXTO ACTUALIZADO: CRÉDITOS
                    tooltip: { title: "Página Legal", text: "Contiene la información técnica: Copyright, ISBN, año de edición, traducción y dirección editorial." }
                },
                back: {
                    type: "text-page",
                    title: "Dedicatoria",
                    text: "<i>A la naturaleza,<br>que siempre cuenta las mejores historias.</i>",
                    tooltip: { title: "Dedicatoria", text: "Espacio íntimo donde el autor ofrece la obra a una persona o causa especial." }
                }
            },
            // CUERPO DEL LIBRO (Imágenes)
        ];

        // -----------------------------------------------------------------------------------------
        // AQUI EMPIEZAN LAS HOJAS INDIVIDUALES
        // -----------------------------------------------------------------------------------------

        // --- HOJA DE CONTENIDO 1 (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/1x.png?raw=true",
                tooltip: { title: "Narrativa Visual", text: "Observa cómo la imagen ocupa todo el espacio." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg2.jpg?raw=true",
                tooltip: { title: "Continuidad", text: "La historia sigue a través de las imágenes." }
            }
        });

        // --- HOJA DE CONTENIDO  (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg3.jpg?raw=true",
                tooltip: { title: "Atmósfera", text: "Los colores transmiten emociones." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg4.jpg?raw=true",
                tooltip: { title: "Detalles", text: "Fíjate en los pequeños elementos." }
            }
        });

        // --- HOJA DE CONTENIDO  (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg%205.jpg?raw=true",
                tooltip: { title: "Narrativa Visual", text: "Sin palabras, la imagen habla." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg%206.png?raw=true",
                tooltip: { title: "Secuencia", text: "El paso de página marca el tiempo." }
            }
        });

        // --- HOJA DE CONTENIDO  (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg7.png?raw=true",
                tooltip: { title: "Perspectiva", text: "Diferentes ángulos enriquecen la historia." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg8.jpg?raw=true",
                tooltip: { title: "Composición", text: "Equilibrio visual en la página." }
            }
        });

        // --- HOJA DE CONTENIDO  (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg9.png?raw=true",
                tooltip: { title: "Luz y Sombra", text: "Crean profundidad y volumen." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg10.jpg?raw=true",
                tooltip: { title: "Expresión", text: "Los personajes muestran sus sentimientos." }
            }
        });

        // --- HOJA DE CONTENIDO  (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg11.jpg?raw=true",
                tooltip: { title: "Entorno", text: "El paisaje es un personaje más." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg12.png?raw=true",
                tooltip: { title: "Acción", text: "El movimiento congelado en el tiempo." }
            }
        });

        // --- HOJA DE CONTENIDO  (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg13.jpg?raw=true",
                tooltip: { title: "Clímax", text: "Momentos de mayor intensidad." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg14.jpg?raw=true",
                tooltip: { title: "Desenlace", text: "La historia comienza a resolverse." }
            }
        });

        // --- HOJA NUEVA EXTRA 1 (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg15.jpg?raw=true", 
                tooltip: { title: "Reflexión", text: "Espacio para pensar." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg16.jpg?raw=true",
                tooltip: { title: "Calma", text: "La tensión disminuye." }
            }
        });

        // --- HOJA NUEVA EXTRA 2 (Cuerpo) ---
        bookData.push({
            front: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg%2017.jpg?raw=true",
                tooltip: { title: "Finalizando", text: "Nos acercamos al cierre." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg%20final.png?raw=true",
                tooltip: { title: "Recuerdo", text: "Imágenes que perduran." }
            }
        });

        // HOJA FINAL: Guardas + Contraportada (Imagen)
        bookData.push({
            front: {
                type: "endpaper",
                tooltip: { title: "Guardas Finales", text: "Cierre físico del libro." }
            },
            back: {
                type: "image-page",
                bg: "https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/contraportada.jpg?raw=true",
                // TEXTO ACTUALIZADO: CONTRAPORTADA
                tooltip: { title: "Contraportada", text: "Cara trasera externa. Lleva la sinopsis, biografía del autor, logo editorial y el código de barras/ISBN." }
            }
        });

        // --- RENDERIZADO ---
        const bookContainer = document.getElementById('book');
        let currentPaperIndex = -1;
        let globalPageCounter = 1; 

        bookData.forEach((sheet, index) => {
            const paper = document.createElement('div');
            paper.className = 'paper';
            paper.style.zIndex = bookData.length - index;
            paper.id = `p-${index}`;

            const frontPageNum = globalPageCounter;
            globalPageCounter++;
            const backPageNum = globalPageCounter;
            globalPageCounter++;
            const totalPages = bookData.length * 2;

            const createFace = (data, isBack, pageNum) => {
                let contentHTML = '';
                if(data.type === 'text-page') {
                    contentHTML = `<h2>${data.title || ''}</h2><p>${data.text || ''}</p>`;
                }

                const bgStyle = data.bg ? `background-image: url('${data.bg}');` : '';
                
                let pageNumberHTML = '';
                if (pageNum > 1 && pageNum < totalPages) {
                    pageNumberHTML = `<span class="page-number">${pageNum}</span>`;
                }

                return `
                <div class="${isBack ? 'back' : 'front'} ${data.type}" style="${bgStyle}">
                    <div class="content-wrapper">${contentHTML}</div>
                    ${pageNumberHTML}
                </div>`;
            };

            paper.innerHTML = createFace(sheet.front, false, frontPageNum) + createFace(sheet.back, true, backPageNum);
            bookContainer.appendChild(paper);
        });

        const papers = document.querySelectorAll('.paper');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        const soundEffect = document.getElementById('pageFlipSound');
        soundEffect.volume = 1.0; 

        function updateState() {
            papers.forEach((p, i) => {
                if(i <= currentPaperIndex) {
                    p.classList.add('flipped');
                    p.style.zIndex = i + 1;
                } else {
                    p.classList.remove('flipped');
                    p.style.zIndex = papers.length - i;
                }
            });

            // --- INICIO DE AJUSTE CORREGIDO ---
            
            const isBookOpen = currentPaperIndex >= 0 && currentPaperIndex < papers.length - 1;
            
            if (isBookOpen) {
                // Libro abierto (Páginas internas)
                bookContainer.classList.add('opened');
                bookContainer.classList.remove('closed-back'); // Asegurar que no esté la clase de cierre
            } else {
                // Libro cerrado (Portada o Contraportada)
                bookContainer.classList.remove('opened');
                
                // Si es la ULTIMA hoja (Contraportada), aplicamos la corrección de centrado
                if (currentPaperIndex === papers.length - 1) {
                    bookContainer.classList.add('closed-back');
                } else {
                    bookContainer.classList.remove('closed-back');
                }
            }
            // --- FIN DE AJUSTE ---

            prevBtn.disabled = currentPaperIndex === -1;
            nextBtn.disabled = currentPaperIndex === papers.length - 1;

            updatePedagogicalLabels();
        }

        function playFlipSound() {
            soundEffect.currentTime = 0;
            var playPromise = soundEffect.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => { })
                .catch(error => { console.log("Audio bloqueado: " + error); });
            }
        }

        function goNext() {
            if (currentPaperIndex < papers.length - 1) {
                playFlipSound(); 
                currentPaperIndex++;
                updateState();
            }
        }

        function goPrev() {
            if (currentPaperIndex >= 0) {
                playFlipSound(); 
                currentPaperIndex--;
                updateState();
            }
        }

        document.addEventListener('keydown', (e) => {
            if(e.key === "ArrowRight") goNext();
            if(e.key === "ArrowLeft") goPrev();
        });

        let zoom = 1;
        function toggleZoom() {
            zoom = zoom === 1 ? 1.2 : 1;
            document.getElementById('stage').style.transform = `scale(${zoom})`;
        }

        function toggleFullScreen() {
            if(!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e=>console.log(e));
            } else {
                document.exitFullscreen();
            }
        }

        // =========================================================================
        // --- SCRIPT: LÓGICA DE NUBES Y PERSONAJES ---
        // =========================================================================
        
        function updatePedagogicalLabels() {
            const containerLeft = document.getElementById('container-left');
            const containerRight = document.getElementById('container-right');

            const cloudLeft = document.getElementById('cloud-left');
            const cloudRight = document.getElementById('cloud-right');
            const titleLeft = document.getElementById('title-left');
            const descLeft = document.getElementById('desc-left');
            const titleRight = document.getElementById('title-right');
            const descRight = document.getElementById('desc-right');
            
            const charLeft = document.getElementById('char-left');
            const charRight = document.getElementById('char-right');

            // 1. Ocultar todo (Fade out)
            cloudLeft.classList.remove('active');
            cloudRight.classList.remove('active');
            charLeft.classList.remove('active');
            charRight.classList.remove('active');

            // 2. Esperar y mostrar la info correcta (y cambiar posición)
            setTimeout(() => {
                let leftInfo = null;
                let rightInfo = null;

                const isLeftUp = Math.random() > 0.5; 
                const isRightUp = !isLeftUp; 

                // Altura base para evitar solapamiento con el libro
                const baseHeight = "calc(50vh - 280px)"; 
                const randomOffsetLeft = Math.floor(Math.random() * 60) + "px";
                const randomOffsetRight = Math.floor(Math.random() * 60) + "px";

                // Posicionamiento Izquierdo
                containerLeft.classList.remove('align-top', 'align-bottom');
                containerLeft.style.paddingTop = "";
                containerLeft.style.paddingBottom = "";
                if (isLeftUp) {
                    containerLeft.classList.add('align-top');
                    containerLeft.style.paddingTop = `calc(${baseHeight} + ${randomOffsetLeft})`;
                } else {
                    containerLeft.classList.add('align-bottom');
                    containerLeft.style.paddingBottom = `calc(${baseHeight} + ${randomOffsetLeft})`;
                }

                // Posicionamiento Derecho
                containerRight.classList.remove('align-top', 'align-bottom');
                containerRight.style.paddingTop = "";
                containerRight.style.paddingBottom = "";
                if (isRightUp) {
                    containerRight.classList.add('align-top');
                    containerRight.style.paddingTop = `calc(${baseHeight} + ${randomOffsetRight})`;
                } else {
                    containerRight.classList.add('align-bottom');
                    containerRight.style.paddingBottom = `calc(${baseHeight} + ${randomOffsetRight})`;
                }

                // --- LÓGICA DE CONTENIDO DINÁMICA ---
                
                // Caso especial: Libro cerrado (Portada)
                if (currentPaperIndex === -1) {
                    // Solo se ve la Portada (derecha)
                    const firstPage = bookData[0].front;
                    if(firstPage.tooltip) rightInfo = firstPage.tooltip;
                } 
                // Caso especial: Libro cerrado (Contraportada)
                else if (currentPaperIndex === papers.length - 1) {
                    // Solo se ve la Contraportada (izquierda)
                    const lastPage = bookData[papers.length - 1].back;
                    if(lastPage.tooltip) leftInfo = lastPage.tooltip;

                }
                // Caso normal: Libro abierto
                else {
                    // Lado IZQUIERDO: Reverso de la página actual volteada
                    const leftPage = bookData[currentPaperIndex].back;
                    if(leftPage && leftPage.tooltip) {
                        leftInfo = leftPage.tooltip;
                    }

                    // Lado DERECHO: Anverso de la siguiente página
                    if (currentPaperIndex + 1 < bookData.length) {
                        const rightPage = bookData[currentPaperIndex + 1].front;
                        if(rightPage && rightPage.tooltip) {
                            rightInfo = rightPage.tooltip;
                        }
                    }
                }

                // Si hay info, llenarla y activar
                if(leftInfo) {
                    titleLeft.textContent = leftInfo.title || "Nota";
                    descLeft.textContent = leftInfo.text || "";
                    cloudLeft.classList.add('active');
                    charLeft.classList.add('active');
                }
                if(rightInfo) {
                    titleRight.textContent = rightInfo.title || "Nota";
                    descRight.textContent = rightInfo.text || "";
                    cloudRight.classList.add('active');
                    charRight.classList.add('active');
                }

            }, 800); 
        }

        // Inicializar estado
        updateState();
    </script>
</body>
</html>
