<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mito Norte Santander | Ajuste Automático</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Montserrat:wght@300;500;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>

    <style>
        :root {
            --paper-texture: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }

        body {
            background-color: #1e293b; /* Fondo oscuro para resaltar el libro */
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 32px 32px;
            font-family: 'Lora', serif;
            margin: 0;
            height: 100vh; /* Altura exacta de la ventana */
            width: 100vw;
            overflow: hidden; /* CRÍTICO: Evita cualquier scroll bar */
            display: flex;
            flex-direction: column;
        }

        /* HEADER (Opcional, para dar aire arriba) */
        .header-space {
            height: 20px;
            flex-shrink: 0;
        }

        /* WRAPPER PRINCIPAL: Ocupa todo el espacio disponible */
        .wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
            perspective: 1500px;
            padding-bottom: 60px; /* Espacio reservado para controles */
        }

        /* EL LIBRO */
        /* No le damos width/height fijos por CSS, lo maneja el JS para ser exacto */
        .stf__wrapper {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Estilos de Página */
        .page {
            background-color: #fcf8f3; 
            background-image: var(--paper-texture);
            border: 1px solid #cbd5e1;
            overflow: hidden;
            background-size: cover; /* Asegura que las texturas cubran todo */
        }

        .page.-left { border-right: none; box-shadow: inset -10px 0 20px -10px rgba(0,0,0,0.2); }
        .page.-right { border-left: none; box-shadow: inset 10px 0 20px -10px rgba(0,0,0,0.2); }

        .hard {
            background-color: #f1f5f9;
            border: solid 1px #94a3b8;
        }

        .page-content {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
        }

        /* --- INTERACTIVIDAD Y HOTSPOTS --- */
        .hotspot-container {
            position: absolute; z-index: 50; transform: translate(-50%, -50%);
        }
        .hotspot-btn {
            width: 36px; height: 36px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #10b981; border-radius: 50%;
            color: #10b981; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .hotspot-btn:hover { transform: scale(1.2); background: #10b981; color: white; }
        .hotspot-btn.speaking { background: #ef4444; border-color: #ef4444; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }

        /* CONTROLES FLOTANTES */
        .controls-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100;
            display: flex; gap: 1rem; align-items: center;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 0.5rem 1.5rem;
            border-radius: 99px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div class="header-space"></div>

    <div class="wrapper">
        <div id="book">
            </div>
    </div>

    <div class="controls-bar">
        <button onclick="flipPrev()" class="p-2 rounded-full hover:bg-gray-200 transition"><i class="ph-bold ph-caret-left text-xl text-gray-800"></i></button>
        <span id="pageIndicator" class="text-xs font-bold text-gray-500 uppercase tracking-widest w-20 text-center">Inicio</span>
        <button onclick="flipNext()" class="p-2 rounded-full hover:bg-gray-200 transition"><i class="ph-bold ph-caret-right text-xl text-gray-800"></i></button>
    </div>

    <div id="startModal" class="fixed inset-0 bg-black/80 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-2xl">
            <h2 class="text-lg font-bold mb-2">Mito Norte Santander</h2>
            <p class="text-sm text-gray-600 mb-4">Ajustado para tu pantalla.</p>
            <input type="password" id="apiKeyInput" placeholder="Gemini API Key (Opcional)" class="w-full border p-2 rounded text-sm mb-4 bg-gray-50">
            <button onclick="startExperience()" class="w-full bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700">Entrar</button>
        </div>
    </div>

    <script>
        let apiKey = "";
        let pageFlip;

        // --- 1. CONTENIDO DEL LIBRO ---
        const bookContent = [
            { type: 'cover', img: 'https://images.unsplash.com/photo-1541963463532-d68292c34b19?w=800', title: "El Mito" },
            { type: 'empty' },
            { type: 'text', text: "Mito Norte Santander", sub: "Edición Adaptable" },
            { type: 'legal', text: "Créditos del proyecto\n2025" },
            // Imágenes de ejemplo
            { type: 'image', img: 'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=800', hotspot: {t: "Inicio", d: "El comienzo.", x: "20%", y: "30%"} },
            { type: 'image', img: 'https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?w=800', hotspot: {t: "Niebla", d: "Misterio.", x: "50%", y: "50%"} },
            { type: 'image', img: 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=800' },
            { type: 'image', img: 'https://images.unsplash.com/photo-1470770841072-f978cf4d019e?w=800' },
            { type: 'image', img: 'https://images.unsplash.com/photo-1533285962552-f9d2a0957948?w=800' },
            { type: 'image', img: 'https://images.unsplash.com/photo-1505506874110-6a7a69069a08?w=800' },
            { type: 'text', text: "Fin" },
            { type: 'cover-back', text: "Sinopsis final." }
        ];

        function startExperience() {
            const input = document.getElementById('apiKeyInput').value;
            if(input) apiKey = input;
            document.getElementById('startModal').style.display = 'none';
            initBook();
        }

        // --- 2. CÁLCULO DE DIMENSIONES (LA MAGIA) ---
        function calculateBookDimensions() {
            // Obtenemos el tamaño real de la ventana
            const winWidth = window.innerWidth;
            const winHeight = window.innerHeight;

            // Espacio que queremos reservar (padding del wrapper + barra de controles)
            const verticalMargin = 100; // 50px arriba, 50px abajo para controles
            const horizontalMargin = 40; // Margen lateral mínimo

            // Espacio disponible real
            const availableHeight = winHeight - verticalMargin;
            const availableWidth = winWidth - horizontalMargin;

            // Relación de aspecto ideal de la hoja (Ej: A4 es aprox 1.41, aquí usaremos 1.5 para pantallas)
            const aspectRatio = 0.7; // Ancho / Alto (de una sola hoja)

            let bookHeight = availableHeight;
            let bookWidth = bookHeight * aspectRatio;

            // Verificación: ¿Cabe el libro abierto (ancho * 2) en el ancho disponible?
            // Si es móvil (pantalla < 768), PageFlip usa modo "single page", si es desktop usa "double".
            const isMobile = winWidth < 768;
            const pagesVisible = isMobile ? 1 : 2;

            if ((bookWidth * pagesVisible) > availableWidth) {
                // Si no cabe a lo ancho, recalculamos basándonos en el ancho
                bookWidth = availableWidth / pagesVisible;
                bookHeight = bookWidth / aspectRatio;
            }

            return { width: Math.floor(bookWidth), height: Math.floor(bookHeight), isMobile };
        }

        function initBook() {
            const bookEl = document.getElementById('book');
            
            // 1. Generar HTML
            let html = bookContent.map((page, i) => {
                let content = '';
                let cls = page.type.includes('cover') ? 'page hard' : 'page';
                
                if (page.type === 'cover') {
                    content = `<div class="w-full h-full flex items-end justify-center pb-10 text-white text-3xl font-bold relative" style="background: url('${page.img}') no-repeat center/cover;"><div class="absolute inset-0 bg-black/20"></div><span class="relative z-10">${page.title}</span></div>`;
                } else if (page.type === 'image') {
                    content = `<div class="w-full h-full relative bg-gray-100" style="background: url('${page.img}') no-repeat center/cover;">
                        ${page.hotspot ? renderHotspot(page.hotspot) : ''}
                        <span class="absolute bottom-2 right-2 text-[10px] bg-white/80 px-1 rounded">${i+1}</span>
                    </div>`;
                } else if (page.type === 'text' || page.type === 'legal' || page.type === 'cover-back') {
                    content = `<div class="h-full flex flex-col items-center justify-center text-center p-6"><h2 class="text-lg font-serif text-slate-800">${page.text}</h2>${page.sub ? `<p class="text-xs text-slate-500 mt-2">${page.sub}</p>` : ''}</div>`;
                } else {
                    content = `<div class="w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>`;
                }
                return `<div class="${cls}"><div class="page-content">${content}</div></div>`;
            }).join('');
            
            bookEl.innerHTML = html;

            // 2. Calcular dimensiones exactas para ESTA pantalla
            const dims = calculateBookDimensions();
            
            // 3. Inicializar PageFlip con dimensiones calculadas
            pageFlip = new St.PageFlip(bookEl, {
                width: dims.width,
                height: dims.height,
                size: 'fixed', // Usamos fixed porque nosotros calculamos el tamaño ideal
                minWidth: 200, maxWidth: 1200,
                minHeight: 300, maxHeight: 1200,
                maxShadowOpacity: 0.5,
                showCover: true,
                mobileScrollSupport: false // Importante: false para evitar scroll del navegador
            });

            pageFlip.loadFromHTML(document.querySelectorAll('.page'));

            // Event listeners
            pageFlip.on('flip', (e) => {
                document.getElementById('pageIndicator').innerText = `Pág ${e.data + 1}`;
            });
            
            attachAudioEvents();
        }

        // --- HOTSPOTS & AUDIO ---
        function renderHotspot(d) {
            return `<div class="hotspot-container" style="left:${d.x}; top:${d.y};">
                <button class="hotspot-btn" data-tts="${d.t}. ${d.d}"><i class="ph-fill ph-speaker-high"></i></button>
            </div>`;
        }

        function attachAudioEvents() {
            document.querySelectorAll('.hotspot-btn').forEach(b => b.onclick = (e) => {
                e.stopPropagation();
                speak(b.dataset.tts, b);
            });
        }

        async function speak(text, btn) {
            if(!apiKey || btn.classList.contains('speaking')) return;
            btn.classList.add('speaking');
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Lee: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"] } })
                });
                const data = await resp.json();
                const audio = new Audio("data:audio/mp3;base64," + data.candidates[0].content.parts[0].inlineData.data);
                audio.play();
                audio.onended = () => btn.classList.remove('speaking');
            } catch(e) { console.error(e); btn.classList.remove('speaking'); }
        }

        function flipNext() { pageFlip.flipNext(); }
        function flipPrev() { pageFlip.flipPrev(); }

        // Recargar si se redimensiona la ventana (para recalcular tamaños)
        let resizeTimeout;
        window.onresize = () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Opcional: window.location.reload(); 
                // PageFlip maneja resize básico, pero para cambio drástico de layout (móvil a desktop) el reload es más seguro
            }, 500);
        };

    </script>
</body>
</html>
